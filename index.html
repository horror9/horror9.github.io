<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>アカウント削除 — 確認</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --accent:#ff5c5c;
      --muted:#9aa4b2; --radius:12px; --gap:18px;
      font-family: Inter, Roboto, "Hiragino Kaku Gothic ProN", "メイリオ", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg,#071021 0%, #0b1220 100%); color:#e6eef6;
      padding:32px;
    }
    .card{
      width:100%; max-width:820px; background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      border-radius:var(--radius); padding:28px; box-shadow:0 8px 30px rgba(2,6,23,0.7);
      border:1px solid rgba(255,255,255,0.03);
    }
    header{display:flex; align-items:center; gap:16px; margin-bottom:10px}
    header h1{font-size:20px; margin:0}
    p.lead{color:var(--muted); margin:6px 0 20px}
    .grid{display:grid; grid-template-columns:1fr 360px; gap:var(--gap)}
    @media (max-width:860px){ .grid{grid-template-columns:1fr; } .aside{order:2} }
    .section{background:rgba(255,255,255,0.02); padding:18px; border-radius:10px; border:1px solid rgba(255,255,255,0.02)}
    .field{margin-bottom:12px}
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    input[type="password"], input[type="text"], textarea{
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04);
      background:transparent; color:inherit; font-size:15px;
    }
    textarea{min-height:92px; resize:vertical}
    .muted{font-size:13px; color:var(--muted)}
    .danger{
      background:linear-gradient(90deg, rgba(255,92,92,0.12), rgba(255,92,92,0.08));
      border:1px solid rgba(255,92,92,0.14);
      color:#ffdede;
    }
    .aside{display:flex; flex-direction:column; gap:12px; align-items:stretch}
    .preview{padding:14px; border-radius:10px; background:rgba(255,255,255,0.012)}
    .btn{
      display:inline-block; padding:10px 14px; border-radius:10px; cursor:pointer;
      border:0; font-weight:600; font-size:14px;
    }
    .btn.danger{background:var(--accent); color:white}
    .btn.ghost{background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted)}
    .actions{display:flex; gap:10px; justify-content:flex-end; margin-top:8px}
    .checkbox{display:flex; gap:10px; align-items:flex-start}
    .tiny{font-size:13px;color:var(--muted)}
    /* modal */
    .modal-backdrop{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(2,6,23,0.6); z-index:60; padding:20px;
    }
    .modal{width:100%; max-width:520px; background:var(--card); border-radius:12px; padding:20px; border:1px solid rgba(255,255,255,0.03)}
    .modal h2{margin:0 0 6px}
    .kbd{font-family:monospace; background:rgba(255,255,255,0.03); padding:2px 6px; border-radius:6px; font-size:13px}
    .error{color:#ffb3b3; font-size:13px; margin-top:6px}
    footer {margin-top:14px; color:var(--muted); font-size:13px}
    /* accessibility focus */
    :focus{outline:3px solid rgba(255,255,255,0.06); outline-offset:2px}
  </style>
</head>
<body>
  <!-- data-username は実際のユーザー名をサーバーから埋め込んでください -->
  <main class="card" role="main" aria-labelledby="page-title" data-username="yamada.taro">
    <header>
      <svg width="36" height="36" viewBox="0 0 24 24" aria-hidden focusable="false"><circle cx="12" cy="12" r="10" fill="#1b2430"/><path d="M12 7v6" stroke="#ff5c5c" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <div>
        <h1 id="page-title">アカウント削除</h1>
        <p class="lead">アカウントを完全に削除すると、復元できません。データはすべて消去されます。</p>
      </div>
    </header>

    <div class="grid" aria-live="polite">
      <section class="section" aria-label="削除フォーム">
        <form id="deleteForm" action="/delete-account" method="POST" novalidate>
          <!-- サーバー側でCSRFトークンを埋め込んでください -->
          <!-- <input type="hidden" name="csrf_token" value="{{csrf_token}}"> -->

          <div class="field">
            <label>アカウント</label>
            <div class="muted" id="accountNameDisplay" aria-live="polite"></div>
          </div>

          <div class="field">
            <label for="password">パスワード（再確認のため）</label>
            <input id="password" name="password" type="password" autocomplete="current-password" required aria-required="true" />
            <div class="tiny muted">アカウント所有の確認のため、現在のパスワードを入力してください。</div>
          </div>

          <div class="field">
            <label for="reason">削除理由（任意）</label>
            <textarea id="reason" name="reason" placeholder="例: サービスを使わなくなった"></textarea>
          </div>

          <div class="field">
            <label for="confirmText">確認 — 以下を正確に入力してください</label>
            <div class="tiny muted">アカウントを削除するには、あなたのアカウント名を正確に入力してください。</div>
            <input id="confirmText" name="confirmText" type="text" placeholder="アカウント名を正確に入力" aria-describedby="confirmHelp" required />
            <div id="confirmHelp" class="tiny muted">例: <span id="sampleName" class="kbd"></span></div>
            <div id="confirmError" class="error" role="status" aria-live="polite" style="display:none"></div>
          </div>

          <div class="field checkbox">
            <input id="ack" type="checkbox" />
            <label for="ack" class="tiny">私はアカウントの削除が不可逆であることを理解しており、データが消去されることに同意します。</label>
          </div>

          <div class="actions">
            <button type="button" id="cancelBtn" class="btn ghost" onclick="location.assign('/settings')">キャンセル</button>
            <button type="button" id="deleteBtn" class="btn danger" disabled aria-disabled="true">アカウントを削除</button>
          </div>
        </form>
        <footer>削除後はログイン不可。請求や支払いに関する情報も削除されます（必要に応じて別途処理が必要）。</footer>
      </section>

      <aside class="aside" aria-label="確認サイドバー">
        <div class="preview section danger" aria-hidden="false">
          <strong>警告</strong>
          <p class="muted">この操作は取り消せません。アカウント名とパスワードの両方を正しく入力する必要があります。</p>
        </div>

        <div class="section preview">
          <strong>なにが消えるか</strong>
          <ul class="tiny muted">
            <li>プロフィールとパブリック情報</li>
            <li>保存済みデータ（投稿、ファイル、設定など）</li>
            <li>サブスクリプションは別途解約が必要な場合があります</li>
          </ul>
        </div>

        <div class="section preview">
          <strong>セキュリティ</strong>
          <p class="tiny muted">サーバー側での再認証（例: メール確認、2段階認証）があると更に安全です。導入推奨。</p>
        </div>
      </aside>
    </div>
  </main>

  <!-- モーダル -->
  <div id="modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <h2 id="modalTitle">最終確認 — 本当に削除しますか？</h2>
      <p class="muted">アカウント: <span id="modalAccount" class="kbd"></span></p>
      <p class="muted">この操作は永久にデータを削除します。復元はできません。</p>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px">
        <button id="modalCancel" class="btn ghost">やめる</button>
        <button id="modalConfirm" class="btn danger">完全に削除する</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const main = document.querySelector('main');
      const username = main.dataset.username || ''; // サーバーで埋めること（安全）
      const accountDisplay = document.getElementById('accountNameDisplay');
      const sampleName = document.getElementById('sampleName');
      const confirmText = document.getElementById('confirmText');
      const ack = document.getElementById('ack');
      const deleteBtn = document.getElementById('deleteBtn');
      const passwordInput = document.getElementById('password');
      const confirmError = document.getElementById('confirmError');

      const modal = document.getElementById('modal');
      const modalAccount = document.getElementById('modalAccount');
      const modalConfirm = document.getElementById('modalConfirm');
      const modalCancel = document.getElementById('modalCancel');

      // 表示
      accountDisplay.textContent = username || '(未設定のユーザー名)';
      sampleName.textContent = username || 'your.username';

      function validate(){
        confirmError.style.display = 'none';
        const typed = confirmText.value.trim();
        const passOk = passwordInput.value.trim().length > 0;
        const typedMatches = typed.length > 0 && typed === username;
        const acknowledged = ack.checked;
        const enable = passOk && typedMatches && acknowledged;
        deleteBtn.disabled = !enable;
        deleteBtn.setAttribute('aria-disabled', String(!enable));
      }

      confirmText.addEventListener('input', validate);
      passwordInput.addEventListener('input', validate);
      ack.addEventListener('change', validate);

      // クリックでモーダルを開いて最終確認
      deleteBtn.addEventListener('click', function(){
        const typed = confirmText.value.trim();
        if(typed !== username){
          confirmError.textContent = '入力したアカウント名が一致しません。正確に入力してください。';
          confirmError.style.display = 'block';
          return;
        }
        modalAccount.textContent = username;
        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden','false');
        // フォーカス移動
        modalConfirm.focus();
      });

      function closeModal(){
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden','true');
        deleteBtn.focus();
      }

      modalCancel.addEventListener('click', closeModal);

      // 最終的にフォームを送る
      modalConfirm.addEventListener('click', function(){
        // サーバー側でパスワード・CSRF・2FA を必ず検証すること
        // ここでは通常のフォーム送信を行う
        // 例えば、fetch() で API 呼び出しする場合はここで行う
        const form = document.getElementById('deleteForm');

        // 見栄えのためにボタンを無効化
        modalConfirm.disabled = true;
        modalConfirm.textContent = '削除実行中...';

        // フォーム送信（通常のPOST） — 必要ならAJAXに置き換えても可
        form.submit();
      });

      // モーダルをエスケープキーで閉じる
      window.addEventListener('keydown', function(e){
        if(e.key === 'Escape' && modal.style.display === 'flex'){
          closeModal();
        }
      });

      // 初回バリデート
      validate();
    })();
  </script>
</body>
</html>
